---
output:
  word_document: default
  pdf_document: default
  html_document: default
---
##---
## title: "Beer Analysis"
## author: "Bodie Franklin, Ellen Lull"
## date: "3/7/2020"
##---
## Project Description
# The goal of this project was to analyze data on 2410 # craft beers created in 558 breweries across the United # States to determine any additional  opportunities for # Budweiser.  Data collected included alcohol by Volume 
# (ABV), International Bitterness Units (IBU) and the Style # of each craft beer.  
##------
##  Load needed libraries 
##  Read Spreadsheets:  Breweries and Beers
##		
```{r}
library(tidyverse)
library(ggplot2)
library(stringr)
library(dplyr)
library(caret)
library(class)

breweries <- read.delim("C:/School Stuff/DS/Doing DS/Project1/breweries.csv",header=TRUE,sep=",")

beer <- read.delim("C:/School Stuff/DS/Doing DS/Project1/beers.csv",header=TRUE,sep=",")
```
#### Question #1  
####
####  Graph to show how many breweries per state
####
```{r}
breweries %>% ggplot(aes(x = State,fill=State )) + 
    geom_bar(stat = "count") +
    ggtitle("Count of Breweries by State") + ylab("Count of Breweries")
```
#### Question #2 
####
####  Merge Beer and Brewery datasets and show first 6 and 
####  last 6 Rows.   Note that this is repeated after
####  the data is cleansed to handle missing values  
####  This section is here to keep the order per
####  the project specifications
####
```{r}
brewbeer <- merge(beer,breweries,by.x="Brewery_id", by.y = "Brew_ID")
 
head(brewbeer,6)
tail(brewbeer,6)

```
#### Question #3 
####
##  This will impute values for missing IBU Values
##  This was done by calculating and averaging the Alpha Acid * Boil Time by Beer Style 
### and imputing IBU Values based on this average

```{r}
IBUTrain = filter(beer,(!is.na(beer$IBU)))

IBUTrain$AABT  <-  (IBUTrain$IBU*7.25)/IBUTrain$Ounces

###this gives us mean AABT by style
AABTMEAN <-IBUTrain %>% group_by(Style) %>% summarise( meanAABT = mean(AABT))


#merge the blank with AABT avgs table by style
Beerwithaabt  <-merge(beer,AABTMEAN,by="Style",all.x=TRUE)

##calculate the IBU based off style avg of AABT

Beerwithaabt$AVG_IBU <- (Beerwithaabt$Ounces*Beerwithaabt$meanAABT)/7.25
```
##### The following will calculate an average ABV by Style
##### to use for missing values.
```{r}
##  Adjust  null ABV Values
ABVTrain = filter(beer,(!is.na(beer$ABV)))
ABVbyStyle <- as.data.frame(ABVTrain %>% group_by(Style) %>% summarise(meanABV = mean(ABV)))
beerwavgs <- merge(Beerwithaabt,ABVbyStyle, by = "Style",all.x = TRUE)
```

####  Add in the Derived ABV and IBU values and omit any 
####  rows where IBU could not be calculated because there 
####  was no training data.  In other words, there 
####  were no rows with valid IBU data for that particular 
####  style of beer
####
```{r}
##  Calculate drvIBU and drvABV fields in final Beer dataset so that we have a value for ABV and IBU to use for all rows
beerfnl1 <- mutate(beerwavgs,drvIBU=ifelse(is.na(IBU),AVG_IBU,IBU))
beerfnl <- mutate(beerfnl1,drvABV=ifelse(is.na(ABV),meanABV,ABV))

#omit remaining null averaged IBU because there was no data to train on.  Mostly Cider
beerfnl2 <- filter(beerfnl,!is.na(drvIBU))
```
####
###  Merge with Breweries.   Get rid of Missing Style.
```{r}
brewdata <- filter(merge(beerfnl2,breweries,by.x="Brewery_id", by.y = "Brew_ID"),!is.na(Style))

```

####  Question 4, 5 6 and 7
####  Graphs to show ABV and IBU by state and 
####  relationships between ABV and IBU

```{r}
### Compute the median alcohol content and international bitterness unit for each state. Plot a bar chart to compare.
brewdata2 <- as.data.frame(brewdata %>% group_by(State) %>% summarise(medibu = mean(drvIBU)))
brewdata3 <- as.data.frame(brewdata %>% group_by(State) %>% summarise(medabv = mean(drvABV)))
brewdata4 <- merge(brewdata2,brewdata3,by="State",all.x=TRUE)


brewdata4 %>% ggplot(aes(x = State, y = medibu, fill=State)) + 
    geom_bar(stat = "identity", ) + 
    ggtitle("Median IBU by State") + 
    xlab ("State") +
    ylab ("International Bitterness Units") +
     theme(legend.position="none")


brewdata4 %>% ggplot(aes(x = State, y = medabv, fill=State)) + 
    geom_bar(stat = "identity", ) + 
    ggtitle("Median ABV by State") + 
    xlab ("State") +
    ylab ("Alcohol by Volume") +
    theme(legend.position="none")


####  Scaled IBU and ABV - not really used #####

brewdata4$scaledibu = scale(brewdata4$medibu,center=FALSE, scale=TRUE)
brewdata4$scaledabv = scale(brewdata4$medabv,center=FALSE, scale=TRUE)

### Make ABV Factors to graph ABV and IBU on same plot

brewdata4$abv_factor = cut(brewdata4$medabv, breaks = c(.05,.057,.059,.062,.069), labels = c("< .057",".057 to .059", ".059 to .062","Above .062"))

brewdata4 %>% ggplot(aes(x = State, y = scaledibu, fill=factor(abv_factor))) + 
    geom_bar(stat = "identity",position="jitter" ) + 
    ggtitle("Median IBU by State and ABV") + 
    xlab ("State") +
    ylab ("IBU") 



brewdata %>%  ggplot(mapping = aes(x = drvABV, y = drvIBU)) + 
     geom_point(position = "jitter",col="Blue") +
     ggtitle("Derived ABV by Derived IBU") + 
    xlab ("Alcohol By Volume") +
    ylab ("International Bittering Units") 


brewdata %>%  ggplot(aes(x = ABV)) + geom_histogram(color='black',fill='darkslategray3') + ggtitle("Histogram of ABV")
```

#####   Question 8
#####   Create a varaible named Typed.  Narrow our analysis to IPA and ALE.   We will be creating a reduced dataset called "final" for this analysis
######

```{r}
final <-brewdata %>% filter(grepl("IPA|India Pale Ale|\\bAle\\b",brewdata$Style))

final$TYPE <-ifelse(str_detect(final$Style,"IPA|India Pale Ale"),"IPA","Ale")
```


```{r}
final$TYPE <-as.factor(final$TYPE)
str(final)

final<-data.frame(Brewery_id =final$Brewery_id, Beer_name = final$Name.x, Beer_ID = final$Beer_ID, Ounces = final$Ounces, drvIBU = final$drvIBU,
                  drvABV = final$drvABV, Brewery_name = final$Name.y, City = final$City, State = final$State, Type = final$TYPE)
                  

nrow(final)

final <-na.omit(final)


####  Graphs for Question 8
#####

ols <- lm(final$drvIBU ~ final$drvABV)
final %>% ggplot(mapping =aes (x=drvABV, y=drvIBU,col=Type)) +
    geom_point(position='jitter') +
    ggtitle("Derived ABV by IBU and Beer Type (Ale or IPA)") +
    xlab ("Derived ABV") +
    ylab ("Derived IBU") +
    geom_abline( intercept = ols$coefficients[1], slope=ols$coefficients[2])

#### OR  - showing the not quite parallel lines:

final %>% ggplot(mapping =aes (x=drvABV, y=drvIBU,col=Type)) +
    geom_point(position='jitter') +
    ggtitle("Derived ABV by IBU and Beer Type (Ale or IPA)") +
    xlab ("Derived ABV") +
    ylab ("Derived IBU") +
    geom_smooth(method='lm')

```
```{r}



```